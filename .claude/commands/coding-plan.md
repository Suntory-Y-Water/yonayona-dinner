---
description: 実装要件から「漏れなく・ダブりなく・直感的に理解できる」具体的計画を作成し、@docs/ai 配下にMarkdownで出力するコマンド
argument-hint: [要件ファイルパス] [参照コード/模範例ファイルパス] [出力スラッグ]
allowed-tools: Read, Grep, Write, Bash(mkdir -p:*), Bash(ls:*), Bash(cat:*), Bash(date:+%Y%m%d)
---

## コンテキスト

- 目的は「正常系の具体的計画」に限る。例外処理（try-catch）は書かせない。
- 異常は**契約（事前条件・不変条件・事後条件）**で防御・検出する。
- Claude Codeが見切り発車しないよう、まずMECEで構造化した計画を固定する。実装は計画合意後。
- ファイル/情報の取得順序は厳守する。  
  1. serena mcp があるときは**メモリから取得** →  
  2. メモリに無ければ**シンボル情報から検索** →  
  3. それでも無ければ **ls / cat 等の標準コマンド**

## 入力

- 要件ファイル: `$1`
- 参照コード/模範例: `$2`
- 出力スラッグ: `$3`

## 出力ファイルの生成

- ディレクトリ作成: !`mkdir -p docs/ai`
- 日付取得: !`date '+%Y-%m-%d'`
- 出力パス: `@docs/ai/$(date +%Y%m%d)-$3.md`
- Write ツールで作成する。

## 計画書テンプレート（この形でWrite出力）

### ゴール
- ビジネス/ユーザー価値（要件から短く要約）
- 完了の定義（DoD。観測可能な条件で記述）

### スコープ
- In（本計画で実施すること。MECEで箇条書き）
- Out（対象外。誤解を防ぐため明示）

### 要件の構造化
- 機能要件（ユースケース観点で粒度を揃える）
- 非機能要件（性能・セキュリティ・運用制約のうち、**正常系に影響する**前提のみ）
- 制約（技術/期限/組織）
- 依存関係（他モジュール・外部API・データ）

### 参照と準拠
- 要件ファイル `$1` の要点引用（該当箇所の原文→要約）
- 模範コード `$2` から抽出する設計原則（例: 早期return、JST変換、命名規約、純粋関数）
- 開発原則: 正常系優先、契約による防御、YAGNI、Baby steps

### 契約による設計
- 入力（型・必須/任意・バリデーション・TZ扱い）
- 不変条件（常に保つ整合性）
- 出力（型・例・形式。JST例: `YYYY-MM-DDTHH:mm:ss`）
- 事前条件（満たさない場合は**契約違反**として即時失敗）
- 事後条件（出力が満たすべき検査）
- エラー表現方針（**try-catchを使わず**契約違反として失敗させる／戻り値で表す等、統一ルールを一文で）

### 実装計画（正常系のみ）
- ステップA（最小価値）: 目的／作業内容／完了条件／依存／ロールバック方法
- ステップB（拡張）
- ステップC（ハードニング：リファクタ／性能※正常系観点）
- 各ステップは**最小変更**で進める。副作用の導入は避ける。

### 擬似コード・フロー（正常系）
- 早期returnと契約チェックを明示した擬似コード
- シーケンスまたはデータフローの簡易図式（テキストで可）

### テスト計画（正常系中心）
- 正常系ケース一覧（代表値・境界値）
- 契約違反ケース（入力/出力検証で自動検出されることの確認。**try-catch禁止**）
- 既存モジュールへの影響（契約境界の回帰観点のみ）

### 変更差分
- 追加/更新/削除ファイル一覧と目的  
  例: `src/utils/time/jst.ts` 追加（JSTフォーマット変換専用）

### 受け入れ基準
- 観測可能な結果（戻り値・ログ・メトリクス・UI/API）
- 契約準拠の確認項目（事前/不変/事後の検査が有効であること）

### 未決事項
- Open Question（曖昧な点・決定者・期限）
- ブロッカー（解消条件を明記）

### 禁止事項
- try-catch の追加（契約で扱う）
- 計画合意前の実装・大規模リファクタ
- 運用・リリース手順の詳細化（本計画の対象外）
