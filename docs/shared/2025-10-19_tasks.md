# 実装計画

- [x] 1. プロジェクト基盤のセットアップ
  - Reactクライアント用にGoogle Maps関連依存関係をインストール（@googlemaps/js-api-loader, @types/google.maps, date-fns, date-fns-tz）
    - packageは`bun install`や`bun install -D`で常に最新版をインストールする
  - 環境変数設定ファイルを作成し、Google Maps API KeyとGoogle Places API Keyを管理できるようにする
    - Cloudflareの設定ファイルは`wrangler.jsonc`である
  - 共通型定義パッケージ（shared）にPlace、OpeningHours、Result等の型を定義
    - 型定義はすべての項目にJsDocでコメントをつける。型の名前だけでなく項目にもJsDocをつける
  - _要件: 全要件に必要な基盤_

- [x] 2. 位置情報サービスと地図表示機能の実装
- [x] 2.1 位置情報取得サービスの構築
  - ブラウザのGeolocation APIを使用して現在地を取得する機能を実装
  - 位置情報パーミッション要求と、許可/拒否の両方のケースに対応
  - パーミッション拒否時に手動設定ガイダンスを表示する処理を実装
  - タイムアウトエラーハンドリングを実装（10秒）
  - _要件: 1.1, 1.2, 1.3, 7.3_

- [x] 2.2 Google Maps表示とダークテーマ適用
  - Google Maps JavaScript APIを使用して地図を初期化し表示
  - ダークテーマスタイルを適用（暗い紫または深い青、白文字、黄金色アクセント）
  - 地図の中心を現在地に設定し、適切なズームレベルを設定
  - 起動から2秒以内に地図が表示されるように最適化
  - _要件: 1.2, 1.4, 1.5, 11.1_

- [x] 3. 店舗検索APIプロキシとキャッシング機能の実装
- [x] 3.1 Honoサーバーに店舗検索エンドポイントを構築
  - Repositoryインターフェースを定義し、Google Places APIを呼び出す具象Repositoryを実装
  - SearchNearbyPlaces Usecaseを実装し、ビジネスロジックを集約
  - Loaderパターンで依存性注入を一元管理
  - Field Maskを使用して必要最小限のフィールドのみ取得（displayName、location、currentOpeningHours、formattedAddress）
  - _要件: 2.1_

- [x] 3.2 Honoキャッシュミドルウェアの統合›
  - `/api/places/search` エンドポイントにHonoキャッシュミドルウェアを適用
  - 位置情報と半径に基づくキャッシュキーを生成（座標は小数点3桁に丸める）
  - TTL 5分のCache-Controlヘッダーを設定
  - Web Standards Cache APIを使用してレスポンスをキャッシュ
  - _要件: 9.1, 9.2, 9.3_

- [x] 3.3 APIエラーハンドリングとリトライロジック
  - Places API呼び出し失敗時のエラーハンドリング（RATE_LIMIT、AUTH_ERROR、NETWORK_ERROR）
  - ネットワークエラー時の指数バックオフリトライ（最大3回）
  - レート制限エラー時の待機処理
  - エラーステータスとメッセージを適切に返却
  - _要件: 7.1_

- [x] 4. 営業時間フィルタリング機能の実装
- [x] 4.1 営業時間判定ロジックの構築
  - 指定時刻に営業中かを判定する純粋関数を実装
  - 24時跨ぎ営業時間に対応（例: 23:30–翌5:00）
  - 複数営業時間スロットに対応（例: 11:00-14:00と17:00-23:00）
  - date-fnsを使用して日時計算を実装
  - _要件: 2.2, 2.3, 2.5, 2.6_

- [x] 4.2 営業中店舗フィルタリング機能
  - 営業時間情報が存在する店舗のみをフィルタリング
  - 営業時間情報がない店舗を検索結果から除外
  - 指定時刻で営業中の店舗のみを返す純粋関数を実装
  - _要件: 2.3, 2.4_

- [x] 4.3 閉店までの残り時間計算機能
  - 現在時刻と閉店時刻の差分を分単位で計算
  - 24時跨ぎ営業での残り時間計算に対応
  - 営業時間外の場合も考慮する
  - _要件: 4.5, 4.6_

- [ ] 5. 地図上のマーカー表示と店舗詳細パネルの実装
- [ ] 5.1 営業中店舗のマーカー配置
  - フィルタリング済みの営業中店舗を地図上に黄金色のピンで表示
  - マーカークリック時のイベントハンドラーを設定
  - マーカーのクリア機能を実装（検索条件変更時に使用）
  - _要件: 2.3, 11.4_

- [ ] 5.2 店舗詳細パネルの構築
  - マーカークリック時に詳細パネルを表示
  - 店名、住所、営業時間、閉店までの残り時間を表示
  - 閉店までの残り時間を「あとXX分」形式で表示
  - Googleマップ起動リンクを表示
  - _要件: 4.1, 4.2, 4.3, 4.4, 4.5, 5.1_

- [ ] 5.3 Googleマップ外部ナビゲーション連携
  - Googleマップ起動リンクをクリックすると、店舗位置情報を含むGoogleマップURLを開く
  - 経路案内の実装をGoogleマップに委任
  - _要件: 5.2, 5.3_

- [ ] 6. 時間帯調整UI機能の実装
- [ ] 6.1 時間帯フィルタUIコンポーネントの構築
  - デフォルトで23:00基準の営業中フィルタを適用
  - 15分刻みで時間帯を調整可能なUIを実装（スライダーまたはセレクトボックス）
  - プリセット時間帯（22:00、23:00、24:00等）を表示
  - shadcn/uiのSliderまたはSelectコンポーネントを使用
  - _要件: 3.1, 3.2, 3.4_

- [ ] 6.2 時間帯変更時の再フィルタリング処理
  - ユーザーが時間帯を変更した際に、変更後の時間帯で営業中店舗を再フィルタリング
  - フィルタリング結果をマーカーに反映（マーカークリア→再配置）
  - サーバーへの再検索は不要（クライアント側でフィルタリング）
  - _要件: 3.3_

- [ ] 7. 検索結果0件時の自動緩和機能の実装
- [ ] 7.1 検索条件の段階的緩和ロジック
  - 検索結果が0件の場合、半径を1段階拡大（800m→1200m）して自動再検索
  - 再検索でも結果が0件の場合、時間帯フィルタを1段階緩和（23:00→22:00）して再フィルタリング
  - すべての緩和策を実行しても結果が0件の場合、メッセージを表示
  - _要件: 6.1, 6.2, 6.3_

- [ ] 8. モバイル最適化とUI配置の実装
- [ ] 8.1 レスポンシブUI設計とタッチ操作最適化
  - すべてのインタラクティブ要素（ボタン、ピン、時間調整UI）を親指で到達可能な位置に配置
  - すべてのタップ可能要素に最小44x44ピクセルのタップ領域を確保
  - 画面下部に主要操作UIを配置
  - モバイル端末で読みやすいフォントサイズ（最小14px）を使用
  - _要件: 8.1, 8.2, 8.3, 8.4_

- [ ] 9. ブランドとUIテーマの適用
- [ ] 9.1 ダークテーマとブランド要素の実装
  - アプリ全体にダークテーマを固定適用（背景: 暗い紫または深い青、文字: 白、アクセント: 黄金色）
  - ロゴを表示（白文字 + 右上にビールの泡が溢れる意匠）
  - UIデザインは装飾を最小限にし、静かで落ち着いたトーンを維持
  - Tailwind CSSのダークテーマ設定を使用
  - _要件: 11.1, 11.2, 11.3_

- [ ] 10. 計測とモニタリング機能の実装
- [ ] 10.1 ユーザー行動とパフォーマンス計測
  - 起動から地図表示までの時間を記録
  - 検索結果件数、検索結果0件の発生回数をカウント
  - 外部マップ遷移をカウント
  - 時間帯別利用分布を記録
  - Web Vitals（CLS、FCP、LCP等）を計測
  - _要件: 12.1, 12.2, 12.3, 12.4, 12.5_

- [ ] 11. データプライバシーとセキュリティ対策の実装
- [ ] 11.1 位置情報の適切な取り扱い
  - 位置情報は端末内でのみ使用し、サーバーに送信しない実装を確認
  - 個人情報をサーバーまたはローカルストレージに保存しない実装を確認
  - Google API規約を遵守（キャッシュTTL 5分以内、Places APIデータの再配布禁止）
  - _要件: 10.1, 10.2, 10.3_

- [ ] 11.2 APIキー保護とCORS設定
  - Google Places API KeyをCloudflare Workers Secretsで管理
  - Google Maps API KeyにHTTPリファラー制限を設定（Cloud Console）
  - HonoサーバーにCORS設定を適用（origin制限、許可メソッド設定）
  - _セキュリティ要件_

- [ ] 12. エンドツーエンド統合とテスト
- [ ] 12.1 初回起動フローの統合
  - アプリ起動→位置情報取得→地図表示→店舗検索→マーカー表示までのフロー全体を統合
  - 起動から2秒以内に地図が表示されることを確認
  - ローディングインジケーターを表示
  - _要件: 1.1, 1.2, 1.4, 2.1, 2.3_

- [ ] 12.2 エラーハンドリングフローの統合
  - 位置情報パーミッション拒否時のガイダンス表示を統合
  - Places API呼び出し失敗時のエラーメッセージ表示を統合
  - Google Maps API読み込み失敗時のフォールバックUI表示を統合
  - _要件: 1.3, 7.1, 7.2, 7.3_

- [ ] 12.3 ユーザーフロー全体のテスト
  - 時間調整UI→再フィルタリング→マーカー更新のフローをテスト
  - マーカークリック→詳細パネル表示→Googleマップ起動のフローをテスト
  - 検索結果0件→自動緩和→再検索のフローをテスト
  - _要件: 3.3, 4.1, 5.2, 6.1_
