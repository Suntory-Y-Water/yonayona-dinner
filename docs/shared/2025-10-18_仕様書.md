## 用語定義
- 現在地：端末の位置情報APIから取得した緯度経度。地図描画および店舗検索の起点となる。
- 中心点：地図上の検索基準点。現在地またはユーザーが手動で指定した位置を指す。
- 検索半径：中心点を基準に周囲を検索する距離（メートル単位）。パフォーマンスと結果件数の調整に用いる。
- 営業スロット：店舗の営業時間を `[open_time, close_time)` の区間で表したもの。翌日を跨ぐ時間帯を許容する。
- 営業中：指定された基準時刻が営業スロットのいずれかに含まれている状態。
- 残り営業分：営業スロットの終了時刻から基準時刻を引いた分数。跨ぎ時間帯では翌日の閉店時刻を採用する。

## 画面と要素
- 地図画面（メイン）：店舗ピンを中心に構成されるアプリの基盤画面。現在地と検索結果を即時に反映。
- ピン詳細（ボトムシート）：店名・住所・営業時間・残り営業時間を表示。外部マップ起動と電話発信を操作項目として含む。
- 設定ダイアログ：検索半径・基準時刻・時間情報不明店舗の表示設定を管理する補助画面。

## データ項目
- placeId：Google Placesで店舗を一意に識別するID。
- name：店舗名。短縮やブランド表記の統一は行わない。
- address：住所。長文の場合は短縮表記を許容。
- location：緯度・経度を格納するオブジェクト。
- openSlots：曜日ごとの営業時間スロット配列。跨ぎ時間を正規化済み。
- isOpen：基準時刻に営業中か否かの真偽値。
- minutesToClose：閉店までの残り時間（分単位）。情報欠如時はnull。
- hasOpeningHours：営業時間データの有無を示すフラグ。

## 営業時間アルゴリズム仕様
- 入力データ：Google Placesの `weekday_text` または `opening_hours`。複数スロットを含むことがある。
- 正規化：当日内スロットはそのまま扱い、跨ぎスロットは `[open, 24:00)` を当日、`[00:00, close)` を翌日に分割する。
- 残り時間算出：`minutesToClose = nearest(slot.end) - t`（分単位、切り捨て）
- 特別営業日：存在する場合は通常スロットより優先。
- 欠落データ：`hasOpeningHours=false` とし、既定では非表示。

## フィルタ仕様
- デフォルト条件：基準時刻＝現在時刻、半径＝800m。
- 今開いている：`isOpen=true`
- もうすぐ閉店：`isOpen=true ∧ minutesToClose ≤ 60`
- この後開く：`isOpen=false ∧ nextOpenStart ≤ 90`（条件を満たさない場合は非表示）

## 再検索トリガ
- 地図パン・ズームで中心が500m以上移動したとき。
- 設定（半径・基準時刻・不明店表示）を変更したとき。
- 検索結果0件時に自動緩和を実施し、半径を800→1200→2000の順で一段階拡大。

## 文言
- 位置情報拒否時：「現在地を利用できませんでした。」
- 検索結果0件時：「お店がありませんでした。」
- 時間不明店舗表示ON時：「時間情報がありません。」

## 計測イベント
- app_open：アプリ起動イベント。cold/warm区別を含む。
- first_paint_ms：初回描画までの時間。
- search_executed：検索実行時に中心座標・半径・結果件数を記録。
- zero_result：結果0件時に緩和種別を記録。
- pin_opened：ピン詳細を開いた店舗のplaceId。
- navigate_clicked：外部マップ遷移の発生ログ。

## 受け入れテスト
- 金曜23:30〜翌5:00営業の店舗  
  - 金23:45 → 営業中（残り75分）  
  - 土00:15 → 営業中（残り285分）
- 11:00–14:30と17:00–24:00の2スロット  
  - 16:50 → 閉店、「この後開く」に該当。
- 0件時に半径拡大が一度だけ行われる。
- 位置情報拒否でも中心指定で検索が成立。
- 60分境界で「もうすぐ閉店」が正しく切り替わる。

## パフォーマンス目標
- 初回結果表示：2,000ms以内（4G想定）
- パン後の再描画：1,200ms以内

## アクセシビリティ
- コントラスト比4.5:1以上。
- 全ての操作要素は44px以上のタップ領域を確保。
- フォーカスインジケータを明示し、夜間でも視認可能。

## リリース前チェックリスト
- 位置情報許可あり／なし両動線で検索可能。
- 跨ぎロジックの単体テストを通過。
- 時間不明店が既定で非表示になっていること。
- 外部マップ遷移がワンタップで動作。
- 計測イベントが全て送信されていること。