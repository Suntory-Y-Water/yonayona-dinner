# タスク 3.1: Honoサーバーに店舗検索エンドポイントを構築

## 概要

設計原則（クリーンアーキテクチャ + DI + Loaderパターン）に基づき、Google Places API (New) を使用した店舗検索エンドポイントを構築します。

## 実装チェックリスト

### 1. 型定義の拡張

- [ ] 1.1 `shared/src/types/index.ts` に `PlacesAPIError` 型を追加
  - `RATE_LIMIT`: レート制限エラー
  - `AUTH_ERROR`: 認証エラー
  - `NETWORK_ERROR`: ネットワークエラー
  - `INVALID_REQUEST`: 無効なリクエスト
  - `SERVICE_UNAVAILABLE`: サービス利用不可
- [ ] 1.2 `shared/src/types/index.ts` に `SearchNearbyRequest` 型を追加
  - `location: LatLng`
  - `radius: number`
- [ ] 1.3 `shared/src/types/index.ts` に `PlacesSearchResponse` 型を追加
  - `places: Place[]`
- [ ] 1.4 `shared/src/types/index.ts` に `Env` 型を追加（Cloudflare Workers Bindings）
  - `GOOGLE_PLACES_API_KEY: string`

### 2. Repositoryインターフェース定義

- [ ] 2.1 `server/src/repositories/interfaces/` ディレクトリを作成
- [ ] 2.2 `server/src/repositories/interfaces/places-repository.interface.ts` を作成
- [ ] 2.3 `IPlacesRepository` 型を定義
  - `searchNearby({ location, radius }: { location: LatLng; radius: number }): Promise<Result<Place[], PlacesAPIError>>`

### 3. 具象Repository実装

- [ ] 3.1 `server/src/repositories/` ディレクトリを作成
- [ ] 3.2 `server/src/repositories/google-places.repository.ts` を作成
- [ ] 3.3 `GooglePlacesRepository` クラスを実装
  - コンストラクタで `apiKey: string` を受け取る
  - `searchNearby` メソッドを実装
    - エンドポイント: `https://places.googleapis.com/v1/places:searchNearby`
    - ヘッダー設定:
      - `Content-Type: application/json`
      - `X-Goog-Api-Key: {apiKey}`
      - `X-Goog-FieldMask: places.id,places.displayName,places.location,places.currentOpeningHours,places.formattedAddress`
    - リクエストボディ:
      - `includedTypes: ['restaurant', 'cafe', 'bar']`
      - `maxResultCount: 20`
      - `locationRestriction: { circle: { center: location, radius } }`
    - エラーハンドリング（Result型で返却）
- [ ] 3.4 `server/src/repositories/google-places.repository.test.ts` を作成
  - 成功ケースのテスト
  - エラーケースのテスト（RATE_LIMIT, AUTH_ERROR, NETWORK_ERROR等）

### 4. Usecase実装

- [ ] 4.1 `server/src/usecases/` ディレクトリを作成
- [ ] 4.2 `server/src/usecases/search-nearby-places.usecase.ts` を作成
- [ ] 4.3 `SearchNearbyPlacesUsecase` クラスを実装
  - コンストラクタで `IPlacesRepository` を受け取る
  - `execute` メソッドを実装
    - パラメータバリデーション（緯度: -90~90, 経度: -180~180, 半径: 1~50000）
    - Repositoryの `searchNearby` 呼び出し
    - Result型で返却
- [ ] 4.4 `server/src/usecases/search-nearby-places.usecase.test.ts` を作成
  - 正常系テスト
  - バリデーションエラーテスト
  - Repository エラー伝播テスト

### 5. Loader実装

- [ ] 5.1 `server/src/loaders/` ディレクトリを作成
- [ ] 5.2 `server/src/loaders/search-places-loader.ts` を作成
- [ ] 5.3 `createSearchPlacesLoader(env: Env)` 関数を実装
  - `GooglePlacesRepository` のインスタンス化（`env.GOOGLE_PLACES_API_KEY` を渡す）
  - `SearchNearbyPlacesUsecase` のインスタンス化
  - Usecaseの `execute` を呼び出す関数を返す
- [ ] 5.4 `server/src/loaders/search-places-loader.test.ts` を作成
  - DI が正しく機能することを確認

### 6. Honoルーター統合

- [ ] 6.1 `server/src/index.ts` に `Bindings` 型定義を追加
  - `GOOGLE_PLACES_API_KEY: string`
- [ ] 6.2 `Hono<{ Bindings: Bindings }>` 型パラメータを設定
- [ ] 6.3 Honoキャッシュミドルウェアをインポート
  - `import { cache } from 'hono/cache'`
- [ ] 6.4 `/api/places/search` POSTエンドポイントを追加
  - キャッシュミドルウェアを適用:
    - `cacheName: 'yonayona-dinner-places'`
    - `cacheControl: 'max-age=300'` (TTL 5分)
    - `keyGenerator`: 座標を小数点3桁に丸めてキャッシュキー生成
      - 形式: `places:{lat}:{lng}:{radius}`
  - リクエストボディのパース（`c.req.json()`）
  - バリデーション実装
  - Loaderの呼び出し（`createSearchPlacesLoader(c.env)`）
  - 成功時: `c.json(result.data)`
  - エラー時: 適切なステータスコードとエラーメッセージを返却
    - `INVALID_REQUEST`: 400
    - `AUTH_ERROR`: 401
    - `RATE_LIMIT`: 429
    - `SERVICE_UNAVAILABLE`: 503
    - その他: 500

### 7. テスト実行と検証

- [ ] 7.1 全ユニットテストを実行（`bun test`）
- [ ] 7.2 型チェックを実行（`bun run ai-check`）
- [ ] 7.3 リントを実行（`bun run ai-check`）
- [ ] 7.4 ビルドを実行（`bun run build`）

### 8. 環境変数設定（実装後）

- [ ] 8.1 開発環境での動作確認
- [ ] 8.2 本番環境に `GOOGLE_PLACES_API_KEY` を設定
  - `bunx wrangler secret put GOOGLE_PLACES_API_KEY`

## 技術仕様

### API仕様
- **エンドポイント**: `POST /api/places/search`
- **リクエストボディ**:
  ```json
  {
    "location": { "lat": 35.6812, "lng": 139.7671 },
    "radius": 800
  }
  ```
- **レスポンス**:
  ```json
  {
    "places": [
      {
        "id": "ChIJ...",
        "displayName": "居酒屋 example",
        "location": { "lat": 35.6812, "lng": 139.7671 },
        "formattedAddress": "東京都...",
        "currentOpeningHours": { ... }
      }
    ]
  }
  ```

### キャッシュ戦略
- **キャッシュキー**: `places:{lat}:{lng}:{radius}`
  - 座標は小数点3桁に丸める（約110m精度）
- **TTL**: 5分（300秒）
- **キャッシュストア**: Cloudflare Workers Cache API

### エラーハンドリング
- Result型パターンを使用
- すべてのエラーを型安全に処理

### 環境変数
- `GOOGLE_PLACES_API_KEY`: Cloudflare Workers Secrets で管理(未決)

## 参考資料

- [Google Places API (New) - Nearby Search](https://developers.google.com/maps/documentation/places/web-service/nearby-search)
- [Hono Cache Middleware](https://hono.dev/docs/middleware/builtin/cache)
- [設計ドキュメント](../design/design_バックエンドコンポーネント.md)
