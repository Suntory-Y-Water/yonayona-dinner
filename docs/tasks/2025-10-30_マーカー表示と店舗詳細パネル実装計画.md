# タスク 5.1～5.3: マーカー表示と店舗詳細パネル実装計画

## 概要

地図上のマーカー表示、店舗詳細パネル（Sheet）、Googleマップ外部ナビゲーション機能を実装します。

## 実装チェックリスト

### 1. 型定義の追加・確認

- [ ] 1.1 `shared/src/types/index.ts` に `DisplayPlace` 型が存在することを確認
  - `Omit<Place, "currentOpeningHours"> & { businessStatus, openingHoursDisplay }`
- [ ] 1.2 `shared/src/types/index.ts` に `BusinessStatus` 型が存在することを確認
  - `isOpenNow: boolean`
  - `remainingMinutes: number`
  - `statusText: string`
- [ ] 1.3 `shared/src/types/index.ts` に `OpeningHoursDisplay` 型が存在することを確認
  - `todayHours: string`
- [ ] 1.4 `shared/src/types/index.ts` に `SearchNearbyRequest` 型が存在することを確認
  - `location: LatLng`
  - `radius: number`
  - `targetTime: JstTimeString`
- [ ] 1.5 型定義にTsDocコメントを追加（初見でも理解できる具体例を記載）

### 2. 店舗検索サービスの実装（Hono RPCクライアント）

- [ ] 2.1 `client/src/services/` ディレクトリを確認（存在しない場合は作成）
- [ ] 2.2 `client/src/services/places-service.ts` を作成
- [ ] 2.3 `searchNearby()` 関数を実装
  - Hono RPCクライアント（`hc`）を使用
  - サーバーの型を`@server`からインポート
  - エンドポイント: `POST /api/places/search`
  - パラメータ: `SearchNearbyRequest`
  - 戻り値: `Promise<Result<DisplayPlacesResponse, PlacesAPIError>>`
  - エラーハンドリング（Result型で返却）
- [ ] 2.4 TsDocコメントを追加（使用例を含む）
- [ ] 2.5 `client/src/services/places-service.test.ts` を作成
  - 成功ケースのテスト
  - エラーケースのテスト（ネットワークエラー等）

### 3. 時刻文字列フォーマット関数

- [ ] 3.1 `client/src/lib/` ディレクトリを確認（存在しない場合は作成）
- [ ] 3.2 `client/src/lib/time-utils.ts` を作成
- [ ] 3.3 `formatToJstTimeString()` 関数を実装
  - パラメータ: `{ date, time }: { date: Date; time: string }`
    - `date`: 基準日（例: `new Date()`）
    - `time`: 時刻文字列（例: `"23:00"`）
  - `date-fns`の`format`と`date-fns-tz`の`toZonedTime`を使用
  - 指定日付の指定時刻をJSTで生成
  - 戻り値: `JstTimeString`（"yyyy-MM-ddTHH:mm:ss"形式）
- [ ] 3.4 TsDocコメントを追加
  - 使用例: `formatToJstTimeString({ date: new Date("2025-10-30"), time: "23:00" })` => `"2025-10-30T23:00:00"`
- [ ] 3.5 `client/src/lib/time-utils.test.ts` を作成
  - 正しいJST時刻文字列が生成されることを検証
  - フォーマットが`"yyyy-MM-ddTHH:mm:ss"`形式であることを検証
  - 異なる時刻（22:00, 23:00, 24:00）でのテスト

### 4. マーカー表示機能の拡張

- [ ] 4.1 `client/src/services/map-service.ts` を読み込み、既存実装を確認
- [ ] 4.2 `displayMarkers()` 関数にクリックイベントパラメータを追加
  - パラメータ: `onMarkerClick: (place: DisplayPlace) => void`
  - `marker.addListener("click", () => onMarkerClick(place))` を実装
  - 既存の黄金色ピン設定を維持
- [ ] 4.3 `clearMarkers()` 関数が存在することを確認（既存実装）
- [ ] 4.4 TsDocコメントを更新（クリックイベントの使用例を追加）
- [ ] 4.5 `client/src/services/map-service.test.ts` を確認
  - クリックイベントのテストを追加

### 5. Googleマップ外部ナビゲーション機能

- [ ] 5.1 `client/src/lib/navigation-utils.ts` を作成
- [ ] 5.2 `openGoogleMaps()` 関数を実装
  - パラメータ: `{ lat, lng }: LatLng`
  - URLスキーム: `https://www.google.com/maps/search/?api=1&query={lat},{lng}`
  - `window.open(url, "_blank")` で新しいタブで開く
- [ ] 5.3 TsDocコメントを追加（使用例を含む）
- [ ] 5.4 `client/src/lib/navigation-utils.test.ts` を作成
  - 正しいURL生成を検証
  - `window.open`のモックテスト

### 6. shadcn/ui Sheetコンポーネントの追加

- [ ] 6.1 shadcn/ui CLIでSheetコンポーネントを追加
  - `bunx shadcn@latest add sheet`
  - `client/src/components/ui/sheet.tsx` が生成されることを確認
- [ ] 6.2 生成されたSheetコンポーネントの型定義を確認
  - `Sheet`, `SheetTrigger`, `SheetContent`, `SheetHeader`, `SheetTitle`, `SheetDescription`等

### 7. 店舗詳細パネルコンポーネントの実装

- [ ] 7.1 `client/src/components/` ディレクトリを確認
- [ ] 7.2 `client/src/components/PlaceDetailPanel.tsx` を作成
- [ ] 7.3 `PlaceDetailPanel` コンポーネントを実装
  - パラメータ:
    - `place: DisplayPlace | null`
    - `isOpen: boolean`
    - `onClose: () => void`
    - `onNavigate: (location: LatLng) => void`
  - Sheetコンポーネントを使用
  - 表示内容:
    - 店名: `place.displayName`（18px以上、白色）
    - 住所: `place.formattedAddress`（14px以上、グレー）
    - 営業時間: `place.openingHoursDisplay.todayHours`（14px以上）
    - 営業ステータス: `place.businessStatus.statusText`（16px以上、黄金色`#FFD700`）
    - Googleマップ起動ボタン（44x44px以上、黄金色背景、黒文字）
  - ダークテーマ対応（Tailwind CSSのdark:クラス）
- [ ] 7.4 TsDocコメントを追加（コンポーネントの使用例を含む）
- [ ] 7.5 `client/src/components/PlaceDetailPanel.test.tsx` を作成
  - 各プロパティの表示を検証
  - ボタンクリック時のコールバック実行を検証

### 8. Homeコンポーネントへの統合

- [ ] 8.1 `client/src/components/Home.tsx` を読み込み、既存実装を確認
- [ ] 8.2 状態変数を追加
  - `const [selectedPlace, setSelectedPlace] = useState<DisplayPlace | null>(null)`
  - `const [isPanelOpen, setIsPanelOpen] = useState(false)`
  - `const [places, setPlaces] = useState<DisplayPlace[]>([])`
  - `const [map, setMap] = useState<google.maps.Map | null>(null)`
  - `const [targetTime, setTargetTime] = useState<string>("23:00")` ※デフォルトは23:00
- [ ] 8.3 店舗検索処理を`useEffect`に追加
  - 地図初期化完了後にトリガー
  - `formatToJstTimeString({ date: new Date(), time: targetTime })`でJST時刻文字列を生成
  - `searchNearby({ location, radius: 800, targetTime: jstTimeString })`を呼び出し
  - Result型でエラーハンドリング
  - 成功時: `setPlaces(data.places)`
- [ ] 8.4 マーカー配置処理を`useEffect`に追加
  - `places`と`map`が存在する場合にトリガー
  - `displayMarkers({ map, places, onMarkerClick: handleMarkerClick })`を呼び出し
  - クリーンアップ関数で`clearMarkers()`を実行
- [ ] 8.5 マーカークリックハンドラーを実装
  - `function handleMarkerClick(place: DisplayPlace)`
  - `setSelectedPlace(place)`
  - `setIsPanelOpen(true)`
- [ ] 8.6 `PlaceDetailPanel`をJSXに追加
  - `<PlaceDetailPanel place={selectedPlace} isOpen={isPanelOpen} onClose={...} onNavigate={openGoogleMaps} />`
  - `onClose`で`setIsPanelOpen(false)`を実行
- [ ] 8.7 ローディングインジケーターを追加（店舗検索中）
- [ ] 8.8 エラーメッセージ表示を追加（API呼び出し失敗時）

### 9. モバイル最適化とアクセシビリティ

- [ ] 9.1 Tailwind CSSでフォントサイズを最小14pxに設定
- [ ] 9.2 ボタンのタップ領域を最小44x44pxに設定
- [ ] 9.3 Sheetを画面下部からスライドイン形式に設定
  - `SheetContent`に`side="bottom"`を設定
- [ ] 9.4 ダークテーマの適用を確認
  - 背景: 暗い紫または深い青
  - 文字: 白
  - アクセント: 黄金色（`#FFD700`）

### 10. テスト実行と検証

- [ ] 10.1 全ユニットテストを実行（`bun test`）
  - `places-service.test.ts`
  - `time-utils.test.ts`（時刻フォーマット関数）
  - `navigation-utils.test.ts`
  - `map-service.test.ts`（既存 + 拡張）
  - `PlaceDetailPanel.test.tsx`
- [ ] 10.2 型チェックを実行（`bun run ai-check`）
- [ ] 10.3 リントを実行（`bun run ai-check`）
- [ ] 10.4 ビルドを実行（`bun run build`）

### 11. E2Eフローの動作確認（手動テスト）

- [ ] 11.1 アプリ起動 → 位置情報取得 → 地図表示を確認
- [ ] 11.2 地図表示後、自動的に店舗検索が実行されることを確認
- [ ] 11.3 黄金色のマーカーが地図上に配置されることを確認
- [ ] 11.4 マーカークリック → Sheet表示を確認
- [ ] 11.5 Sheet内の表示内容を確認
  - 店名、住所、営業時間、営業ステータスが表示される
  - 営業ステータスが黄金色で表示される
- [ ] 11.6 [Googleマップで開く]ボタンクリック → 新しいタブでGoogleマップが開くことを確認
- [ ] 11.7 Sheet閉じるボタンで正しく閉じることを確認
- [ ] 11.8 モバイルブラウザ（Chrome DevTools）での表示を確認
  - タップ領域が適切か
  - フォントサイズが読みやすいか
  - Sheetが画面下部からスライドインするか

### 12. エラーハンドリングの動作確認

- [ ] 12.1 位置情報取得失敗時のエラーメッセージ表示を確認（既存実装）
- [ ] 12.2 店舗検索API失敗時のエラーメッセージ表示を確認
- [ ] 12.3 マーカー配置失敗時のエラーログ出力を確認

## 技術仕様

### API仕様

- **エンドポイント**: `POST /api/places/search`
- **リクエストボディ**:
  ```json
  {
    "location": { "lat": 35.6812, "lng": 139.7671 },
    "radius": 800,
    "targetTime": "2025-10-30T23:00:00"
  }
  ```
- **レスポンス**:
  ```json
  {
    "places": [
      {
        "id": "ChIJ...",
        "displayName": "居酒屋 example",
        "location": { "lat": 35.6812, "lng": 139.7671 },
        "formattedAddress": "東京都...",
        "businessStatus": {
          "isOpenNow": true,
          "remainingMinutes": 120,
          "statusText": "営業中（あと2時間）"
        },
        "openingHoursDisplay": {
          "todayHours": "18:00～翌2:00"
        }
      }
    ]
  }
  ```

### Googleマップ外部ナビゲーション

- **URLスキーム**: `https://www.google.com/maps/search/?api=1&query={lat},{lng}`
- **動作**:
  - デスクトップ: 新しいタブでGoogleマップを開く
  - モバイル: Googleマップアプリで開く（インストール済みの場合）

### UIコンポーネント

- **Sheet（shadcn/ui）**:
  - 位置: 画面下部（`side="bottom"`）
  - アニメーション: スライドイン
  - 背景: ダークテーマ（暗い紫または深い青）
- **Button（shadcn/ui）**:
  - タップ領域: 最小44x44px
  - 背景色: 黄金色（`#FFD700`）
  - 文字色: 黒

### フォントサイズとカラー

- **店名**: 18px以上、白（`text-foreground`）
- **住所**: 14px以上、グレー（`text-muted-foreground`）
- **営業時間**: 14px以上
- **営業ステータス**: 16px以上、黄金色（`text-[#FFD700]`）

### 検索パラメータ

- **初期半径**: 800メートル
- **初期時刻**: "23:00"（デフォルト値、タスク6で時間調整UI実装予定）
- **位置情報**: ユーザーの現在地
- **時刻フォーマット**: `formatToJstTimeString()`で現在日付 + 時刻文字列 → JstTimeString形式に変換

## エラーハンドリング

- Result型パターンを使用
- すべてのエラーを型安全に処理
- ユーザーにわかりやすいエラーメッセージを表示

## パフォーマンス要件

- 起動から地図表示まで2秒以内（要件1.4）
- 店舗検索はキャッシュ利用（TTL 5分、バックエンド実装済み）
- マーカー配置は非同期処理でUIブロックを防ぐ

## 参考資料

- [設計ドキュメント](../design/design_マーカー表示と店舗詳細パネル.md)
- [Google Maps JavaScript API - Advanced Markers](https://developers.google.com/maps/documentation/javascript/advanced-markers/overview)
- [Google Maps URLs](https://developers.google.com/maps/documentation/urls/get-started)
- [shadcn/ui - Sheet](https://ui.shadcn.com/docs/components/sheet)
- [date-fns documentation](https://date-fns.org/)
