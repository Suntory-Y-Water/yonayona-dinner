# リファクタリング計画書: DisplayPlace型への移行

## 目的

現在の`FilteredPlace`から新しい`DisplayPlace`型への移行により、バックエンドに責務を集約し、フロントエンドをシンプルに保つ。

## 影響範囲

### 変更が必要なファイル

#### shared パッケージ

- `shared/src/types/index.ts`
  - 新規追加: `DisplayPlaceSchema`, `DisplayPlace`, `DisplayPlacesResponseSchema`, `DisplayPlacesResponse`
  - 非推奨マーク: `FilteredPlaceSchema`, `FilteredPlace`, `FilteredPlacesResponseSchema`, `FilteredPlacesResponse`

#### server パッケージ

**新規追加ファイル**
- `server/src/domain/opening-hours/format-business-status.ts`
- `server/src/domain/opening-hours/format-business-status.test.ts`
- `server/src/domain/opening-hours/format-opening-hours.ts`
- `server/src/domain/opening-hours/format-opening-hours.test.ts`
- `server/src/domain/opening-hours/to-display-place.ts`
- `server/src/domain/opening-hours/to-display-place.test.ts`

**修正が必要なファイル**
- `server/src/usecases/search-nearby-places.usecase.ts`
  - import文を`FilteredPlacesResponse`から`DisplayPlacesResponse`に変更
  - `toFilteredPlace()`を`toDisplayPlace()`に置き換え
- `server/src/usecases/search-nearby-places.usecase.test.ts`
  - テストケースを新しい型に対応
- `server/src/loaders/search-places-loader.ts`
  - import文を`FilteredPlacesResponse`から`DisplayPlacesResponse`に変更
- `server/src/loaders/search-places-loader.test.ts`
  - テストケースを新しい型に対応
- `server/src/index.ts`
  - レスポンス型の変更（ただしJSONとして返却するため実質的な影響なし）

**削除予定ファイル（Phase 4）**
- `server/src/domain/opening-hours/to-filtered-place.ts`
- `server/src/domain/opening-hours/to-filtered-place.test.ts`

#### client パッケージ

- 現時点で`FilteredPlace`や`FilteredPlacesResponse`は**未使用**のため、変更不要
- 将来的にAPI連携を実装する際は`DisplayPlace`を使用

#### docs パッケージ

- `docs/design/design_バックエンドコンポーネント.md`
  - レスポンススキーマを`DisplayPlace`に更新
  - 責務の明確化
- `docs/design/design_フロントエンドコンポーネント.md`
  - PlacesServiceの契約を`DisplayPlace`に更新
- `docs/design/design_共通層とデータモデル.md`
  - 型定義の更新

## リファクタリング手順（Todoリスト）

### Phase 1: 型定義の追加と既存型の非推奨化

- [ ] 1-1. `shared/src/types/index.ts`に`DisplayPlaceSchema`を追加
- [ ] 1-2. `shared/src/types/index.ts`に`DisplayPlacesResponseSchema`を追加
- [ ] 1-3. `FilteredPlaceSchema`に`@deprecated`コメントを追加
- [ ] 1-4. `FilteredPlacesResponseSchema`に`@deprecated`コメントを追加
- [ ] 1-5. `bun run build`でsharedパッケージをビルド
- [ ] 1-6. 型チェックエラーがないことを確認

### Phase 2: 新しいドメインサービスの実装

- [ ] 2-1. `format-business-status.ts`を実装
  - TsDocコメントを追加
  - 入力・出力を具体的に記載
- [ ] 2-2. `format-business-status.test.ts`を実装
  - Given-When-Thenパターンで記述
  - 事前条件、事後条件、不変条件をテスト
  - `AGENT=1 bun test --bail=2`で実行し、パスすることを確認
- [ ] 2-3. `format-opening-hours.ts`を実装
  - TsDocコメントを追加
  - 入力・出力を具体的に記載
- [ ] 2-4. `format-opening-hours.test.ts`を実装
  - Given-When-Thenパターンで記述
  - 事前条件、事後条件、不変条件をテスト
  - `AGENT=1 bun test --bail=2`で実行し、パスすることを確認
- [ ] 2-5. `to-display-place.ts`を実装
  - TsDocコメントを追加
  - 入力・出力を具体的に記載
- [ ] 2-6. `to-display-place.test.ts`を実装
  - Given-When-Thenパターンで記述
  - 事前条件、事後条件、不変条件をテスト
  - `AGENT=1 bun test --bail=2`で実行し、パスすることを確認

### Phase 3: 既存コードの修正

- [ ] 3-1. `search-nearby-places.usecase.ts`を修正
  - import文を`DisplayPlacesResponse`に変更
  - `toFilteredPlace()`を`toDisplayPlace()`に置き換え
  - 戻り値の型を`Result<DisplayPlacesResponse, PlacesAPIError>`に変更
- [ ] 3-2. `search-nearby-places.usecase.test.ts`を修正
  - テストケースを新しい型に対応
  - `AGENT=1 bun test --bail=2`で実行し、パスすることを確認
- [ ] 3-3. `search-places-loader.ts`を修正
  - import文を`DisplayPlacesResponse`に変更
  - 戻り値の型を`Result<DisplayPlacesResponse, PlacesAPIError>`に変更
- [ ] 3-4. `search-places-loader.test.ts`を修正
  - テストケースを新しい型に対応
  - `AGENT=1 bun test --bail=2`で実行し、パスすることを確認
- [ ] 3-5. `server/src/index.ts`を修正
  - レスポンス型の更新（コメントのみ）
- [ ] 3-6. 全テストを実行
  - `AGENT=1 bun test`で全テストがパスすることを確認
- [ ] 3-7. `bun run ai-check`でリント・型チェックを実行
  - エラーがないことを確認

### Phase 4: APIエンドポイントの動作確認

- [ ] 4-1. ローカルでサーバーを起動
  - `bun run dev`でサーバーを起動
- [ ] 4-2. APIエンドポイントの動作確認
  - curlまたはPostmanで`POST /api/places/search`を実行
  - レスポンスに`businessStatus`と`openingHoursDisplay`が含まれることを確認
  - `currentOpeningHours`が含まれていないことを確認

### Phase 5: 設計書の更新

- [ ] 5-1. `docs/design/design_バックエンドコンポーネント.md`を更新
  - レスポンススキーマを`DisplayPlace`に変更
  - 責務の説明を更新
- [ ] 5-2. `docs/design/design_フロントエンドコンポーネント.md`を更新
  - PlacesServiceの契約を`DisplayPlace`に変更
  - フロントエンドの責務を明確化
- [ ] 5-3. `docs/design/design_共通層とデータモデル.md`を更新
  - 型定義の更新

### Phase 6: 旧コードのクリーンアップ

- [ ] 6-1. `server/src/domain/opening-hours/to-filtered-place.ts`を削除
- [ ] 6-2. `server/src/domain/opening-hours/to-filtered-place.test.ts`を削除
- [ ] 6-3. `shared/src/types/index.ts`から`FilteredPlaceSchema`を削除
- [ ] 6-4. `shared/src/types/index.ts`から`FilteredPlacesResponseSchema`を削除
- [ ] 6-5. `bun run build`でsharedパッケージをビルド
- [ ] 6-6. `AGENT=1 bun test`で全テストがパスすることを確認
- [ ] 6-7. `bun run ai-check`でリント・型チェックを実行

## 実装上の注意事項

### コーディング規約の遵守

1. **関数の引数**
   - 2個以上の引数はオブジェクト形式で設定
   - 例: `function formatBusinessStatus({ isOpenNow, remainingMinutes }: { isOpenNow: boolean; remainingMinutes: number })`

2. **TsDocコメント**
   - 全ての関数に詳細なTsDocコメントを追加
   - 初めて見た人でも使い方や入力・出力がわかる例を掲載
   - 説明を省略せず具体的に記載

3. **テスト方針**
   - Given-When-Thenパターンで記述
   - 事前条件、事後条件、不変条件を検証
   - TDDを実施（テストを先に書く）

4. **型定義**
   - interfaceではなくtypeを使用
   - 構造的に型づけする
   - 既存の型定義を再利用（PickやOmitを活用）

## リスク管理

### 潜在的なリスク

1. **レスポンスサイズの増加**
   - 対策: 表示用テキストは最小限に抑える
   - 影響: キャッシュが有効なため、実質的な影響は小さい

2. **バックエンドの処理時間増加**
   - 対策: 文字列整形は軽量な処理のため影響は微小
   - 影響: キャッシュミドルウェアにより、実質的な影響は小さい

3. **既存のテストコードの修正漏れ**
   - 対策: Phase 3でテストを段階的に修正し、都度確認
   - 対策: `AGENT=1 bun test`で全テストを実行

### ロールバック手順

Phase 1-2の段階では既存コードに影響がないため、ロールバック不要。
Phase 3以降で問題が発生した場合は、以下の手順でロールバック：

1. Phase 3の修正をrevert
2. `bun run build`と`AGENT=1 bun test`を実行
3. 問題が解決することを確認

## 完了条件

- [ ] 全てのPhaseのタスクが完了
- [ ] `bun run ai-check`でエラーなし
- [ ] `AGENT=1 bun test`で全テストがパス
- [ ] APIエンドポイントが新しいレスポンス構造を返却
- [ ] 設計書が更新済み

## タイムライン（推定）

- **Phase 1**: 30分
- **Phase 2**: 2時間（TDDで実装）
- **Phase 3**: 1.5時間
- **Phase 4**: 30分
- **Phase 5**: 30分
- **Phase 6**: 30分

**合計**: 約5.5時間

## 次のステップ

1. このリファクタリング計画書をレビュー
2. Phase 1から順次実装開始
3. 各Phaseの完了後、Todoリストを更新
4. 全Phase完了後、フロントエンドとの結合作業を開始
