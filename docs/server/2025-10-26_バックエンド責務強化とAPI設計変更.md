# バックエンド責務強化とAPI設計変更

## 概要

現在のAPI設計では、フロントエンドに営業時間の表示処理やUI生成の責務が肥大化する懸念があります。
このドキュメントでは、「フロントエンドはAPIレスポンスをそのまま画面に表示するだけ」という原則に基づき、バックエンド側に責務を集約する設計変更案を提示します。

## 現状の課題

### 現在のレスポンス構造

```json
{
  "places": [{
    "id": "ChIJ__8Lhf2LGGARYj6XJNBik14",
    "displayName": "日本橋髙島屋S.C.",
    "formattedAddress": "日本、〒103-8265 東京都中央区日本橋２丁目４−１",
    "location": { "lat": 35.6808238, "lng": 139.77343489999998 },
    "currentOpeningHours": {
      "openNow": true,
      "periods": [
        {
          "open": { "day": 0, "hour": 10, "minute": 30 },
          "close": { "day": 0, "hour": 19, "minute": 30 }
        },
        ...
      ],
      "weekdayDescriptions": [
        "月曜日: 10時30分～19時30分",
        ...
      ]
    },
    "rating": 4.1,
    "remainingMinutes": 20
  }]
}
```

### 問題点

1. **フロントエンドへの責務肥大化**
   - `currentOpeningHours`の生データが含まれており、フロントエンドで解析・整形が必要になる
   - `periods`配列から今日の営業時間を抽出するロジックが必要
   - 営業ステータスの表示テキスト生成（例: "営業中（あと20分）"）をフロントエンドで実装する必要がある

2. **テスタビリティの低下**
   - フロントエンド側に複雑なロジックが入ると、E2Eテストが不安定になる
   - 表示テキストの検証が困難

3. **保守性の低下**
   - 営業時間の表示形式を変更する場合、フロントエンドを修正する必要がある
   - 多言語対応時にフロントエンド側で言語切り替えロジックが必要になる

## 設計変更案: DisplayPlace型の導入

### 新しいZodスキーマ定義

`shared/src/types/index.ts`に以下のスキーマを追加します。

```typescript
/**
 * 営業状態情報のスキーマ
 *
 * バックエンドで計算・整形済みの営業状態を表す。
 * フロントエンドは`statusText`をそのまま表示するだけでよい。
 *
 * @example
 * ```ts
 * const result = BusinessStatusSchema.safeParse({
 *   isOpenNow: true,
 *   remainingMinutes: 120,
 *   statusText: "営業中（あと2時間）"
 * });
 * ```
 */
export const BusinessStatusSchema = z.object({
  /** 現在営業中かどうか */
  isOpenNow: z.boolean(),
  /** 閉店までの残り時間（分、0の場合は閉店中または営業時間外） */
  remainingMinutes: z.number().int().min(0),
  /** 表示用ステータステキスト（例: "営業中（あと20分）", "閉店中", "本日の営業は終了しました"） */
  statusText: z.string(),
});

/**
 * 営業状態情報
 */
export type BusinessStatus = z.infer<typeof BusinessStatusSchema>;

/**
 * 表示用営業時間情報のスキーマ
 *
 * バックエンドで整形済みの営業時間を表す。
 * フロントエンドは文字列をそのまま表示するだけでよい。
 *
 * @example
 * ```ts
 * const result = OpeningHoursDisplaySchema.safeParse({
 *   todayHours: "18:00～翌2:00",
 *   weeklyHours: [
 *     "月曜日: 18:00～翌2:00",
 *     "火曜日: 18:00～翌2:00"
 *   ]
 * });
 * ```
 */
export const OpeningHoursDisplaySchema = z.object({
  /** 今日の営業時間（例: "10:30～19:30", "18:00～翌2:00", "定休日"） */
  todayHours: z.string(),
  /** 週次営業時間（例: ["月曜日: 10:30～19:30", ...]） */
  weeklyHours: z.array(z.string()),
});

/**
 * 表示用営業時間情報
 */
export type OpeningHoursDisplay = z.infer<typeof OpeningHoursDisplaySchema>;

/**
 * 表示用店舗情報のスキーマ
 *
 * フロントエンドはこのレスポンスをそのまま画面に表示するだけで、
 * 営業時間の計算や整形は一切不要。
 *
 * @example
 * ```ts
 * const result = DisplayPlaceSchema.safeParse({
 *   id: "ChIJ...",
 *   displayName: "居酒屋やまと",
 *   location: { lat: 35.6762, lng: 139.6503 },
 *   formattedAddress: "東京都新宿区...",
 *   rating: 4.5,
 *   businessStatus: {
 *     isOpenNow: true,
 *     remainingMinutes: 120,
 *     statusText: "営業中（あと2時間）"
 *   },
 *   openingHoursDisplay: {
 *     todayHours: "18:00～翌2:00",
 *     weeklyHours: ["月曜日: 18:00～翌2:00", ...]
 *   }
 * });
 * ```
 */
export const DisplayPlaceSchema = z.object({
  /** 一意識別子（Google Place ID） */
  id: z.string(),
  /** 表示名 */
  displayName: z.string(),
  /** 位置情報 */
  location: LatLngSchema,
  /** 住所 */
  formattedAddress: z.string(),
  /** 評価（0.0-5.0、任意） */
  rating: z.number().min(0).max(5).optional(),
  /** 営業状態 */
  businessStatus: BusinessStatusSchema,
  /** 表示用営業時間 */
  openingHoursDisplay: OpeningHoursDisplaySchema,
});

/**
 * 表示用店舗情報
 */
export type DisplayPlace = z.infer<typeof DisplayPlaceSchema>;

/**
 * 表示用店舗レスポンスのスキーマ
 *
 * @example
 * ```ts
 * const result = DisplayPlacesResponseSchema.safeParse({
 *   places: [
 *     {
 *       id: "ChIJ...",
 *       displayName: "居酒屋 example",
 *       location: { lat: 35.68, lng: 139.76 },
 *       formattedAddress: "東京都...",
 *       businessStatus: {
 *         isOpenNow: true,
 *         remainingMinutes: 120,
 *         statusText: "営業中（あと2時間）"
 *       },
 *       openingHoursDisplay: {
 *         todayHours: "18:00～翌2:00",
 *         weeklyHours: ["月曜日: 18:00～翌2:00"]
 *       }
 *     }
 *   ]
 * });
 * if (result.success) {
 *   console.log(result.data.places[0]?.businessStatus.statusText);
 * }
 * ```
 */
export const DisplayPlacesResponseSchema = z.object({
  /** 営業中店舗リスト */
  places: z.array(DisplayPlaceSchema),
});

/**
 * 表示用店舗レスポンス
 */
export type DisplayPlacesResponse = z.infer<typeof DisplayPlacesResponseSchema>;
```

### レスポンス例

```json
{
  "places": [{
    "id": "ChIJ__8Lhf2LGGARYj6XJNBik14",
    "displayName": "日本橋髙島屋S.C.",
    "formattedAddress": "日本、〒103-8265 東京都中央区日本橋２丁目４−１",
    "location": { "lat": 35.6808238, "lng": 139.77343489999998 },
    "rating": 4.1,
    "businessStatus": {
      "isOpenNow": true,
      "remainingMinutes": 20,
      "statusText": "営業中（あと20分）"
    },
    "openingHoursDisplay": {
      "todayHours": "10:30～19:30",
      "weeklyHours": [
        "月曜日: 10:30～19:30",
        "火曜日: 10:30～19:30",
        "水曜日: 10:30～19:30",
        "木曜日: 10:30～19:30",
        "金曜日: 10:30～19:30",
        "土曜日: 10:30～19:30",
        "日曜日: 10:30～19:30"
      ]
    }
  }]
}
```

## 設計の利点

### バックエンド側の責務

#### 1. 営業ステータスの計算と整形

```typescript
/**
 * 営業ステータスを表示用テキストに整形する
 *
 * バックエンドでビジネスロジックを完結させ、
 * フロントエンドは`statusText`をそのまま表示するだけでよい。
 *
 * @example
 * ```ts
 * const status = formatBusinessStatus({
 *   isOpenNow: true,
 *   remainingMinutes: 120
 * });
 * // => "営業中（あと2時間）"
 * ```
 *
 * @example
 * ```ts
 * const status = formatBusinessStatus({
 *   isOpenNow: false,
 *   remainingMinutes: 0
 * });
 * // => "閉店中"
 * ```
 */
export function formatBusinessStatus({
  isOpenNow,
  remainingMinutes,
}: {
  isOpenNow: boolean;
  remainingMinutes: number;
}): string;
```

#### 2. 営業時間の整形

```typescript
/**
 * 営業時間を表示用テキストに整形する
 *
 * Google Places APIの生データから、
 * フロントエンドで直接表示できる形式に変換する。
 *
 * @example
 * ```ts
 * const display = formatOpeningHours({
 *   openingHours: {
 *     openNow: true,
 *     periods: [...],
 *     weekdayDescriptions: ["月曜日: 18:00～翌2:00", ...]
 *   },
 *   targetTime: "2025-10-27T20:00:00"
 * });
 * // => {
 * //   todayHours: "18:00～翌2:00",
 * //   weeklyHours: ["月曜日: 18:00～翌2:00", ...]
 * // }
 * ```
 *
 * @example
 * ```ts
 * const display = formatOpeningHours({
 *   openingHours: undefined,
 *   targetTime: "2025-10-27T20:00:00"
 * });
 * // => {
 * //   todayHours: "営業時間情報なし",
 * //   weeklyHours: []
 * // }
 * ```
 */
export function formatOpeningHours({
  openingHours,
  targetTime,
}: {
  openingHours: OpeningHours | undefined;
  targetTime: JstTimeString;
}): { todayHours: string; weeklyHours: string[] };
```

#### 3. Place → DisplayPlace 変換

```typescript
/**
 * PlaceをDisplayPlaceへ変換する
 *
 * ビジネスロジック（営業時間判定、残り時間計算、テキスト整形）を実行し、
 * フロントエンドで直接表示できる形式に変換する。
 *
 * @example
 * ```ts
 * const display = toDisplayPlace({
 *   place: {
 *     id: "ChIJ...",
 *     displayName: "居酒屋やまと",
 *     location: { lat: 35.6762, lng: 139.6503 },
 *     formattedAddress: "東京都新宿区...",
 *     currentOpeningHours: { ... },
 *     rating: 4.5
 *   },
 *   targetTime: "2025-10-27T20:00:00"
 * });
 * console.log(display.businessStatus.statusText); // "営業中（あと2時間）"
 * console.log(display.openingHoursDisplay.todayHours); // "18:00～翌2:00"
 * ```
 */
export function toDisplayPlace({
  place,
  targetTime,
}: {
  place: Place;
  targetTime: JstTimeString;
}): DisplayPlace;
```

#### 4. ビジネスロジックの集約

- 24時跨ぎ営業時間の処理
- 複数営業時間スロットの処理
- 定休日の判定と表示

### フロントエンド側の責務

1. **表示のみ**
   - `businessStatus.statusText`をそのまま表示
   - `openingHoursDisplay.todayHours`をそのまま表示
   - `openingHoursDisplay.weeklyHours`をリスト表示

2. **利点**
   - ロジックがシンプル（表示するだけ）
   - テストが容易（APIレスポンスをモックするだけ）
   - 保守性が高い（表示形式の変更はバックエンドで完結）

## 実装計画

### Phase 1: 型定義の追加（shared）

- `DisplayPlaceSchema`を`shared/src/types/index.ts`に追加
- `DisplayPlacesResponseSchema`を追加
- 既存の`FilteredPlace`と`FilteredPlacesResponse`は**非推奨**としてマーク（削除はPhase 4）

### Phase 2: バックエンド機能の実装

1. **新しいドメインサービスの追加**
   - `server/src/domain/opening-hours/format-business-status.ts`
   - `server/src/domain/opening-hours/format-opening-hours.ts`
   - `server/src/domain/opening-hours/to-display-place.ts`

2. **既存コードの修正**
   - `SearchNearbyPlacesUsecase.execute()`: `DisplayPlacesResponse`を返すように変更
   - `toFilteredPlace()`を`toDisplayPlace()`に置き換え

3. **テストコードの追加**
   - 各新機能に対するユニットテスト
   - 営業ステータステキストの生成テスト
   - 営業時間整形のテスト

### Phase 3: APIエンドポイントの更新

- `server/src/index.ts`: レスポンス型を`DisplayPlacesResponse`に変更
- キャッシュキー生成ロジックは変更なし

### Phase 4: 旧型定義のクリーンアップ

- `FilteredPlace`と`FilteredPlacesResponse`を削除
- `to-filtered-place.ts`を削除
- 関連するテストコードを削除

## 設計原則の明確化

### バックエンドの責務

- **データ取得**: Google Places APIからの店舗情報取得
- **ビジネスロジック**: 営業時間判定、フィルタリング、残り時間計算
- **データ整形**: 表示用テキストの生成、営業時間の整形
- **キャッシング**: APIレスポンスのキャッシング

### フロントエンドの責務

- **表示**: APIレスポンスをそのまま画面に表示
- **ユーザーインタラクション**: 地図操作、マーカークリック、時間帯調整
- **ナビゲーション**: 画面遷移、外部マップ起動

### 境界の明確化

- バックエンド: **計算・整形・ビジネスロジック**
- フロントエンド: **表示・インタラクション**

## まとめ

この設計変更により、以下を実現します：

1. **フロントエンドのシンプル化**: 表示するだけでロジック不要
2. **テスタビリティの向上**: バックエンド側でテストが完結
3. **保守性の向上**: 表示形式の変更がバックエンドで完結
4. **設計原則の遵守**: 責務の明確な分離

フロントエンドとバックエンドがまだ結合していない現時点で実施することで、将来的な負債を回避できます。